<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enhanced Cash Flow Manager</title>
  <style>
    /* Overall page styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1, h2, h3 {
      color: #2c3e50;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    section {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    form input, form select, form button {
      margin: 8px 0;
      padding: 10px;
      width: 100%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    form button {
      background-color: #2980b9;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    form button:hover {
      background-color: #1c5980;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      background: #ecf0f1;
      margin: 6px 0;
      padding: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item-text {
      flex: 1;
      margin-right: 10px;
    }
    .delete-btn {
      background-color: #e74c3c;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
    .edit-btn {
      background-color: #27ae60;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .edit-btn:hover {
      background-color: #1e8449;
    }
    .account-summary {
      border: 1px solid #bdc3c7;
      margin: 10px 0;
      padding: 15px;
      border-radius: 6px;
      background: #fdfdfd;
    }
    .hidden {
      display: none;
    }
    table {
      width: auto;
      margin-bottom: 10px;
    }
    table, th, td {
      border: 1px solid #666;
      border-collapse: collapse;
      padding: 5px;
    }
    /* Expense Totals Section styling */
    #expense-totals {
      border: 2px solid #2980b9;
      padding: 15px;
      border-radius: 8px;
      background: #eaf2f8;
    }
    #expense-totals h2 {
      margin-top: 0;
    }
    #expense-totals h3 {
      margin-bottom: 5px;
    }
    #expense-totals p {
      font-size: 0.95em;
      color: #555;
    }
    .totals-list {
      margin: 10px 0;
      padding-left: 20px;
    }
    /* New styles for sections */
    #balanceTrackingToggleContainer {
      margin-bottom: 15px;
    }
    #balanceTrackingToggleContainer p {
      font-size: 0.9em;
      color: #555;
    }
    #distribution-section {
      margin-bottom: 20px;
    }
    #customAllocationCounter {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Enhanced Cash Flow Manager</h1>

  <!-- Paydays Section -->
  <section id="paydays">
    <h2>Paydays</h2>
    <form id="paydayForm">
      <label for="paydayType">Payday Type:</label>
      <select id="paydayType" required>
        <option value="">Select Type</option>
        <option value="specific">Specific Day</option>
        <option value="1st15">1st and 15th</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
      <!-- For "specific" type -->
      <div id="specificDayInput" class="hidden">
        <label for="specificDay">Day of Month (1–31):</label>
        <input type="number" id="specificDay" placeholder="e.g., 15" min="1" max="31">
      </div>
      <label for="paycheckAmount">Expected Paycheck Amount (after-tax):</label>
      <input type="number" id="paycheckAmount" placeholder="e.g., 2000" step="0.01" required>
      <button type="submit">Add Payday</button>
    </form>
    <ul id="paydayList"></ul>
  </section>

  <!-- CSV Import Section for Recurring Bills -->
  <section id="csv-import">
    <h2>CSV Import for Recurring Bills</h2>
    <p>
      You can import recurring bills from a CSV file. The CSV must have exactly these columns:
      <code>Bill Name, Bill Amount, Due Date, Bank Account</code>.<br>
      <strong>Important:</strong> Any bank listed in the CSV that is not already in the manual Bank Accounts section will be automatically added.
    </p>
    <p>Sample table:</p>
    <table>
      <tr>
        <th>Bill Name</th>
        <th>Bill Amount</th>
        <th>Due Date</th>
        <th>Bank Account</th>
      </tr>
      <tr>
        <td>Rent</td>
        <td>1200</td>
        <td>1</td>
        <td>Main Checking</td>
      </tr>
      <tr>
        <td>Electricity</td>
        <td>100</td>
        <td>15</td>
        <td>Main Checking</td>
      </tr>
    </table>
    <br>
    <label for="recurringCSV">Upload Recurring Bills CSV:</label>
    <input type="file" id="recurringCSV" accept=".csv">
  </section>

  <!-- Bank Accounts Section -->
  <section id="bank-accounts">
    <h2>Bank Accounts</h2>
    <div id="balanceTrackingToggleContainer">
      <label>
        <input type="checkbox" id="balanceTrackingToggle">
        Track Bank Account Balances?
      </label>
      <p>When enabled, the system will track your bank account balances using your starting balances and paycheck allocations. This allows you to monitor if your account can cover upcoming expenses.</p>
    </div>
    <form id="bankAccountForm">
      <input type="text" id="bankName" placeholder="Bank Account Name" required>
      <input type="number" id="bankBalance" placeholder="Initial Balance (optional)" step="0.01">
      <button type="submit">Add Bank Account</button>
    </form>
    <ul id="bankAccountList"></ul>
  </section>

  <!-- Paycheck Distribution Section (visible only if tracking is enabled) -->
  <section id="distribution-section" class="hidden">
    <h2>Paycheck Distribution Method</h2>
    <select id="distributionMethod">
      <option value="equal">Equal Split</option>
      <option value="custom">Custom Allocation</option>
      <option value="single">Single Account</option>
      <option value="proportional">Proportional to Expenses</option>
    </select>
    <div id="customAllocationFields" class="hidden">
      <!-- Custom allocation inputs will be generated here -->
      <div id="customAllocationCounter">Remaining to distribute: $0</div>
    </div>
    <div id="singleAccountSelectorContainer" class="hidden">
      <label for="singleAccountSelector">Select Account for Full Paycheck:</label>
      <select id="singleAccountSelector">
        <!-- Options will be populated with bank accounts -->
      </select>
    </div>
  </section>

  <!-- Recurring Bills Section -->
  <section id="recurring-bills">
    <h2>Recurring Bills</h2>
    <form id="billForm">
      <input type="text" id="billName" placeholder="Bill Name (e.g., Rent)" required>
      <input type="number" id="billAmount" placeholder="Bill Amount" required step="0.01">
      <input type="number" id="billDueDate" placeholder="Due Date (Day 1–31)" required min="1" max="31">
      <select id="billBankAccount" required>
        <option value="">Select Bank Account</option>
      </select>
      <button type="submit">Add Recurring Bill</button>
    </form>
    <ul id="billList"></ul>
  </section>

  <!-- Periodic Expenses Section -->
  <section id="oneTime-expenses">
    <h2>Periodic Expenses</h2>
    <p>
      Periodic Expenses are costs that do not occur every month but need to be planned for on a regular basis.
      For example, car insurance that is due twice a year or a gym membership that is only due in certain months.
    </p>
    <form id="expenseForm">
      <input type="text" id="expenseName" placeholder="Expense Name (e.g., Car Insurance)" required>
      <input type="number" id="expenseAmount" placeholder="Expense Amount" required step="0.01">
      <input type="number" id="expenseDueDate" placeholder="Due Day (1–31)" required min="1" max="31">
      <select id="expenseBankAccount" required>
        <option value="">Select Bank Account</option>
      </select>
      <h3>Expense Plan Type</h3>
      <div>
        <label>
          <input type="radio" name="expensePlanType" value="occurrence" checked>
          Occurrences Per Year
        </label>
        <p style="margin-left: 20px; font-size: 0.9em; color: #555;">
          Use this option if the expense occurs a fixed number of times per year.
          For example, if your car insurance is due twice a year, set Occurrences Per Year to 2.
        </p>
      </div>
      <div>
        <label>
          <input type="radio" name="expensePlanType" value="specific">
          Specific Months
        </label>
        <p style="margin-left: 20px; font-size: 0.9em; color: #555;">
          Use this option if you know the exact months when the expense is due.
          For example, if your gym membership is due in January and July, add 1 and 7 respectively.
        </p>
      </div>
      <div id="occurrenceSection">
        <input type="number" id="expenseOccurrences" placeholder="Occurrences Per Year (e.g., 2)" min="0">
      </div>
      <div id="specificMonthsSection" class="hidden">
        <label for="expenseMonthSelect">Select Month:</label>
        <select id="expenseMonthSelect">
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
        <button type="button" id="addExpenseMonthBtn">Add Month</button>
        <ul id="expenseMonthsList"></ul>
      </div>
      <button type="submit">Add Periodic Expense</button>
    </form>
    <ul id="expenseList"></ul>
  </section>

  <!-- Calculate Required Balances Section -->
  <section id="calculation">
    <h2>Calculate Required Balances</h2>
    <label for="cycleDate">Select Cycle Date:</label>
    <input type="date" id="cycleDate" required>
    <button id="calculateButton">Calculate</button>
  </section>

  <!-- Required Balances Summary Section -->
  <section id="output">
    <h2>Required Balances Summary</h2>
    <div id="results"></div>
  </section>

  <!-- Expense Totals Section -->
  <section id="expense-totals">
    <h2>Expense Totals</h2>
    <div id="payPeriodTotals">
      <h3>Pay-Period Expense Totals</h3>
      <p id="payPeriodRange">(from Day ? to Day ? - Total: ? days)</p>
      <div id="payPeriodCombined"></div>
      <div id="payPeriodByBank"></div>
    </div>
    <div id="monthlyTotals">
      <h3>Monthly Expense Totals</h3>
      <p>This section shows the total monthly expenses along with a breakdown by bank account and lists all bills.</p>
      <div id="monthlyCombined"></div>
      <div id="monthlyByBank"></div>
    </div>
  </section>

  <script>
    /**************************************************************
     * Data storage arrays for bank accounts, recurring bills,
     * periodic expenses, and paydays.
     **************************************************************/
    let bankAccounts = [];
    let recurringBills = [];
    let oneTimeExpenses = [];
    let paydays = [];
    let balanceTrackingEnabled = false;

    let tempExpenseMonths = [];

    /**************************************************************
     * Helper: Get days in month based on the selected cycle date.
     **************************************************************/
    function getCycleDaysInMonth() {
      const cycleDateVal = document.getElementById('cycleDate').value;
      if (cycleDateVal) {
        let dt = new Date(cycleDateVal);
        return new Date(dt.getFullYear(), dt.getMonth()+1, 0).getDate();
      }
      return 31;
    }

    /**************************************************************
     * Helper: Get the most recent payday day (start of pay period) based on selected day.
     **************************************************************/
    function getMostRecentPaydayDay(selectedDay, daysInMonth) {
      let recentDay = null;
      let recentEffective = -1;
      paydays.forEach(pd => {
        let effDay;
        if(pd.type === 'specific'){
          effDay = effectiveDueDate(pd.day, daysInMonth);
        } else if(pd.type === '1st15'){
          effDay = (selectedDay >= 15) ? 15 : 1;
        } else if(pd.type === 'daily'){
          effDay = selectedDay;
        } else if(pd.type === 'weekly'){
          effDay = (selectedDay > 7) ? (selectedDay - 7) : selectedDay;
        } else if(pd.type === 'monthly'){
          effDay = daysInMonth;
        }
        if(effDay <= selectedDay && effDay > recentEffective) {
          recentEffective = effDay;
          recentDay = effDay;
        }
      });
      if(recentDay === null) {
        paydays.forEach(pd => {
          let effDay;
          if(pd.type === 'specific'){
            effDay = effectiveDueDate(pd.day, daysInMonth);
          } else if(pd.type === '1st15'){
            effDay = 15;
          } else if(pd.type === 'daily'){
            effDay = selectedDay;
          } else if(pd.type === 'weekly'){
            effDay = selectedDay;
          } else if(pd.type === 'monthly'){
            effDay = daysInMonth;
          }
          if(effDay > recentEffective) {
            recentEffective = effDay;
            recentDay = effDay;
          }
        });
      }
      return recentDay;
    }

    /**************************************************************
     * Utility: Update bank account dropdowns in bills and expenses.
     **************************************************************/
    function updateBankAccountDropdowns() {
      const billSelect = document.getElementById('billBankAccount');
      const expenseSelect = document.getElementById('expenseBankAccount');

      billSelect.innerHTML = '<option value="">Select Bank Account</option>';
      expenseSelect.innerHTML = '<option value="">Select Bank Account</option>';

      bankAccounts.forEach(account => {
        const option1 = document.createElement('option');
        option1.value = account.id;
        option1.textContent = account.name;
        billSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = account.id;
        option2.textContent = account.name;
        expenseSelect.appendChild(option2);
      });
    }

    /**************************************************************
     * Update distribution section options.
     **************************************************************/
    function updateDistributionSection() {
      const singleAccountSelector = document.getElementById('singleAccountSelector');
      singleAccountSelector.innerHTML = "";
      bankAccounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = account.name;
        singleAccountSelector.appendChild(option);
      });
      if(document.getElementById('distributionMethod').value === "custom") {
        updateCustomAllocationFields();
      }
    }

    /**************************************************************
     * Update custom allocation fields for each bank account.
     **************************************************************/
    function updateCustomAllocationFields() {
      const customAllocDiv = document.getElementById('customAllocationFields');
      customAllocDiv.innerHTML = "";
      bankAccounts.forEach(account => {
        const div = document.createElement('div');
        div.innerHTML = `<label for="customAlloc_${account.id}">${account.name} Allocation:</label>
                         <input type="number" id="customAlloc_${account.id}" placeholder="Amount" step="0.01">`;
        customAllocDiv.appendChild(div);
        const inputElem = div.querySelector('input');
        inputElem.addEventListener('input', updateCustomAllocationCounter);
      });
      const counterDiv = document.createElement('div');
      counterDiv.id = "customAllocationCounter";
      counterDiv.textContent = "Remaining to distribute: $0";
      customAllocDiv.appendChild(counterDiv);
    }

    function updateCustomAllocationCounter() {
      let target = paydays.length > 0 ? paydays[0].paycheckAmount : 0;
      let sum = 0;
      bankAccounts.forEach(account => {
        let input = document.getElementById('customAlloc_' + account.id);
        if(input && input.value) {
          sum += parseFloat(input.value);
        }
      });
      let remaining = target - sum;
      const counterElem = document.getElementById('customAllocationCounter');
      if(counterElem) {
        counterElem.textContent = "Remaining to distribute: $" + remaining.toFixed(2);
      }
    }

    /**************************************************************
     * Show/hide the specific day input for paydays.
     **************************************************************/
    document.getElementById('paydayType').addEventListener('change', function() {
      const specificInput = document.getElementById('specificDayInput');
      if (this.value === 'specific') {
        specificInput.classList.remove('hidden');
      } else {
        specificInput.classList.add('hidden');
      }
    });

    /**************************************************************
     * Toggle: Enable or disable balance tracking.
     **************************************************************/
    document.getElementById('balanceTrackingToggle').addEventListener('change', function() {
      balanceTrackingEnabled = this.checked;
      const distributionSection = document.getElementById('distribution-section');
      if(balanceTrackingEnabled) {
        distributionSection.classList.remove('hidden');
      } else {
        distributionSection.classList.add('hidden');
      }
      updateBankAccountList();
    });

    /**************************************************************
     * Distribution Method Change: Show/hide custom allocation or single account selector.
     **************************************************************/
    document.getElementById('distributionMethod').addEventListener('change', function() {
      const method = this.value;
      const customDiv = document.getElementById('customAllocationFields');
      const singleDiv = document.getElementById('singleAccountSelectorContainer');
      if(method === "custom") {
        customDiv.classList.remove('hidden');
        singleDiv.classList.add('hidden');
        updateCustomAllocationFields();
      } else if(method === "single") {
        singleDiv.classList.remove('hidden');
        customDiv.classList.add('hidden');
        updateDistributionSection();
      } else {
        customDiv.classList.add('hidden');
        singleDiv.classList.add('hidden');
      }
    });

    /**************************************************************
     * Add a new Payday.
     **************************************************************/
    document.getElementById('paydayForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const type = document.getElementById('paydayType').value;
      let day = null;
      if (!type) {
        alert("Please select a payday type.");
        return;
      }
      if (type === 'specific') {
        day = parseInt(document.getElementById('specificDay').value);
        if (isNaN(day) || day < 1 || day > 31) {
          alert("Enter a valid day of month (1–31).");
          return;
        }
      }
      const paycheckAmount = parseFloat(document.getElementById('paycheckAmount').value);
      if (isNaN(paycheckAmount) || paycheckAmount <= 0) {
        alert("Enter a valid expected paycheck amount.");
        return;
      }
      const id = Date.now().toString() + "_pd";
      paydays.push({ id, type, day, paycheckAmount });
      updatePaydayList();
      document.getElementById('paydayType').value = "";
      document.getElementById('specificDay').value = "";
      document.getElementById('paycheckAmount').value = "";
      document.getElementById('specificDayInput').classList.add('hidden');
    });

    /**************************************************************
     * Update the Payday list UI.
     **************************************************************/
    function updatePaydayList() {
      const paydayList = document.getElementById('paydayList');
      paydayList.innerHTML = "";
      paydays.forEach(pd => {
        let pdText = "";
        if (pd.type === 'specific') {
          pdText = "Day " + pd.day;
        } else if (pd.type === '1st15') {
          pdText = "1st and 15th";
        } else {
          pdText = pd.type.charAt(0).toUpperCase() + pd.type.slice(1);
        }
        pdText += " – Paycheck: $" + pd.paycheckAmount.toFixed(2);
        const li = document.createElement('li');
        li.innerHTML = `<span class="item-text">${pdText}</span>`;
        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.classList.add('delete-btn');
        delBtn.addEventListener('click', function() {
          paydays = paydays.filter(item => item.id !== pd.id);
          updatePaydayList();
        });
        li.appendChild(delBtn);
        paydayList.appendChild(li);
      });
    }

    /**************************************************************
     * Bank Account: Add a new bank account.
     **************************************************************/
    document.getElementById('bankAccountForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('bankName').value;
      const balanceInput = document.getElementById('bankBalance').value;
      const balance = (balanceTrackingEnabled) ? (balanceInput ? parseFloat(balanceInput) : 0) : (balanceInput ? parseFloat(balanceInput) : null);
      const id = Date.now().toString() + "_bank";
      bankAccounts.push({ id, name, balance });
      updateBankAccountList();
      updateBankAccountDropdowns();
      updateDistributionSection();
      document.getElementById('bankName').value = '';
      document.getElementById('bankBalance').value = '';
    });

    /**************************************************************
     * Update Bank Accounts list UI.
     * Adds a green "Edit" button if balance tracking is enabled.
     **************************************************************/
    function updateBankAccountList() {
      const bankList = document.getElementById('bankAccountList');
      bankList.innerHTML = "";
      bankAccounts.forEach(account => {
        const balText = (account.balance !== null && !isNaN(account.balance)) ? `$${account.balance.toFixed(2)}` : "N/A";
        const li = document.createElement('li');
        li.innerHTML = `<span class="item-text">${account.name} - Balance: ${balText}</span>`;
        if(balanceTrackingEnabled) {
          const editBtn = document.createElement('button');
          editBtn.textContent = "Edit";
          editBtn.classList.add('edit-btn');
          editBtn.addEventListener('click', function() {
            const newBalance = prompt("Enter new starting balance for " + account.name, account.balance);
            if(newBalance !== null) {
              account.balance = parseFloat(newBalance);
              updateBankAccountList();
            }
          });
          li.insertBefore(editBtn, li.firstChild);
        }
        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.classList.add('delete-btn');
        delBtn.addEventListener('click', function() {
          bankAccounts = bankAccounts.filter(item => item.id !== account.id);
          recurringBills = recurringBills.filter(bill => bill.bankAccountId !== account.id);
          oneTimeExpenses = oneTimeExpenses.filter(exp => exp.bankAccountId !== account.id);
          updateBankAccountList();
          updateBankAccountDropdowns();
          updateDistributionSection();
          updateBillList();
          updateExpenseList();
        });
        li.appendChild(delBtn);
        bankList.appendChild(li);
      });
    }

    /**************************************************************
     * Recurring Bill: Add a new recurring bill.
     **************************************************************/
    document.getElementById('billForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('billName').value;
      const amount = parseFloat(document.getElementById('billAmount').value);
      let dueDate = parseInt(document.getElementById('billDueDate').value);
      const bankAccountId = document.getElementById('billBankAccount').value;
      if (!bankAccountId) {
        alert("Please select a bank account for the bill.");
        return;
      }
      const id = Date.now().toString() + "_bill";
      recurringBills.push({ id, name, amount, dueDate, bankAccountId });
      updateBillList();
      document.getElementById('billName').value = '';
      document.getElementById('billAmount').value = '';
      document.getElementById('billDueDate').value = '';
      document.getElementById('billBankAccount').value = '';
    });

    /**************************************************************
     * Update Recurring Bills list UI.
     **************************************************************/
    function updateBillList() {
      const billList = document.getElementById('billList');
      billList.innerHTML = "";
      const days = getCycleDaysInMonth();
      recurringBills.forEach(bill => {
        const bankAccount = bankAccounts.find(acc => acc.id === bill.bankAccountId);
        const li = document.createElement('li');
        li.classList.add("bill-item");
        li.innerHTML = `<span class="item-text">${bill.name} - $${bill.amount.toFixed(2)} due on Day ${effectiveDueDate(bill.dueDate, days)} from ${bankAccount ? bankAccount.name : ""}</span>`;
        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.classList.add('delete-btn');
        delBtn.addEventListener('click', function() {
          recurringBills = recurringBills.filter(item => item.id !== bill.id);
          updateBillList();
        });
        li.appendChild(delBtn);
        billList.appendChild(li);
      });
    }

    /**************************************************************
     * Expense Plan Type toggle.
     **************************************************************/
    const expensePlanTypeRadios = document.getElementsByName('expensePlanType');
    expensePlanTypeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        if(this.value === 'occurrence') {
          document.getElementById('occurrenceSection').classList.remove('hidden');
          document.getElementById('specificMonthsSection').classList.add('hidden');
        } else {
          document.getElementById('occurrenceSection').classList.add('hidden');
          document.getElementById('specificMonthsSection').classList.remove('hidden');
        }
      });
    });

    /**************************************************************
     * Specific Months: Add month selection for periodic expense.
     **************************************************************/
    document.getElementById('addExpenseMonthBtn').addEventListener('click', function() {
      const monthSelect = document.getElementById('expenseMonthSelect');
      const month = monthSelect.value;
      if (!tempExpenseMonths.includes(month)) {
        tempExpenseMonths.push(month);
        updateExpenseMonthsList();
      }
    });

    function updateExpenseMonthsList() {
      const list = document.getElementById('expenseMonthsList');
      list.innerHTML = "";
      tempExpenseMonths.forEach((m, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="item-text">${monthName(parseInt(m))}</span>`;
        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.classList.add('delete-btn');
        delBtn.addEventListener('click', function() {
          tempExpenseMonths.splice(index, 1);
          updateExpenseMonthsList();
        });
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    function monthName(m) {
      const names = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      return names[m - 1] || "";
    }

    /**************************************************************
     * Periodic Expense: Add a new periodic expense.
     **************************************************************/
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('expenseName').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      let dueDate = parseInt(document.getElementById('expenseDueDate').value);
      const bankAccountId = document.getElementById('expenseBankAccount').value;
      if (!bankAccountId) {
        alert("Please select a bank account for the expense.");
        return;
      }
      let planType = document.querySelector('input[name="expensePlanType"]:checked').value;
      let occurrences = 0;
      let specificMonths = [];
      if(planType === 'occurrence') {
        occurrences = parseInt(document.getElementById('expenseOccurrences').value) || 0;
      } else if(planType === 'specific') {
        specificMonths = [...tempExpenseMonths];
        tempExpenseMonths = [];
        updateExpenseMonthsList();
      }
      const id = Date.now().toString() + "_expense";
      oneTimeExpenses.push({ id, name, amount, dueDate, bankAccountId, planType, occurrences, specificMonths });
      updateExpenseList();
      document.getElementById('expenseName').value = '';
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDueDate').value = '';
      document.getElementById('expenseBankAccount').value = '';
      document.getElementById('expenseOccurrences').value = '';
      document.querySelector('input[name="expensePlanType"][value="occurrence"]').checked = true;
      document.getElementById('occurrenceSection').classList.remove('hidden');
      document.getElementById('specificMonthsSection').classList.add('hidden');
    });

    /**************************************************************
     * Update Periodic Expenses list UI.
     **************************************************************/
    function updateExpenseList() {
      const expenseList = document.getElementById('expenseList');
      expenseList.innerHTML = "";
      oneTimeExpenses.forEach(exp => {
        const bankAccount = bankAccounts.find(acc => acc.id === exp.bankAccountId);
        let expText = `${exp.name} - $${exp.amount.toFixed(2)} due on Day ${exp.dueDate}`;
        if(exp.planType === 'occurrence' && exp.occurrences > 0) {
          expText += ` | Occurs ${exp.occurrences}x/yr`;
        } else if(exp.planType === 'specific' && exp.specificMonths.length > 0) {
          expText += ` | Due in: ${exp.specificMonths.map(m => monthName(parseInt(m))).join(', ')}`;
        } else {
          expText += " (One-Time)";
        }
        const li = document.createElement('li');
        li.classList.add("expense-item");
        li.innerHTML = `<span class="item-text">${expText} from ${bankAccount ? bankAccount.name : ""}</span>`;
        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete";
        delBtn.classList.add('delete-btn');
        delBtn.addEventListener('click', function() {
          oneTimeExpenses = oneTimeExpenses.filter(item => item.id !== exp.id);
          updateExpenseList();
        });
        li.appendChild(delBtn);
        expenseList.appendChild(li);
      });
    }

    /**************************************************************
     * Helper: For bills due on 29-31 in a month with fewer days,
     * return the effective due date.
     **************************************************************/
    function effectiveDueDate(dueDate, daysInMonth) {
      return (dueDate > daysInMonth) ? daysInMonth : dueDate;
    }

    /**************************************************************
     * Helper: Compute expected pay periods per year based on paydays.
     **************************************************************/
    function getExpectedPayPeriodsPerYear() {
      let periods = 12;
      if (paydays.some(pd => pd.type === 'daily')) {
         periods = 365;
      } else if (paydays.some(pd => pd.type === 'weekly')) {
         periods = 52;
      } else if (paydays.some(pd => pd.type === '1st15')) {
         periods = 24;
      }
      return periods;
    }

    /**************************************************************
     * Helper: Compute next payday difference (in days) from the selected day.
     **************************************************************/
    function computeNextPaydayDiff(selectedDay, daysInMonth) {
      let differences = [];
      paydays.forEach(pd => {
        let diff = 0;
        if(pd.type === 'specific'){
          let pdDay = effectiveDueDate(pd.day, daysInMonth);
          if(pdDay >= selectedDay){
            diff = pdDay - selectedDay;
          } else {
            diff = (daysInMonth - selectedDay) + pdDay;
          }
        } else if(pd.type === '1st15'){
          if(selectedDay < 15){
            diff = 15 - selectedDay;
          } else {
            diff = daysInMonth - selectedDay;
          }
        } else if(pd.type === 'daily'){
          diff = 1;
        } else if(pd.type === 'weekly'){
          diff = 7;
        } else if(pd.type === 'monthly'){
          let pdDay = daysInMonth;
          if(selectedDay <= pdDay){
            diff = pdDay - selectedDay;
          } else {
            diff = (daysInMonth - selectedDay) + pdDay;
          }
        }
        differences.push(diff);
      });
      return Math.min(...differences);
    }

    /**************************************************************
     * Helper: Get the most recent paycheck amount based on selected day.
     **************************************************************/
    function getMostRecentPaycheck(selectedDay, daysInMonth) {
      let recent = null;
      let recentEffectiveDay = -1;
      paydays.forEach(pd => {
        let effDay;
        if(pd.type === 'specific'){
          effDay = effectiveDueDate(pd.day, daysInMonth);
        } else if(pd.type === '1st15'){
          effDay = (selectedDay >= 15) ? 15 : 1;
        } else if(pd.type === 'daily'){
          effDay = selectedDay;
        } else if(pd.type === 'weekly'){
          effDay = (selectedDay > 7) ? (selectedDay - 7) : selectedDay;
        } else if(pd.type === 'monthly'){
          effDay = daysInMonth;
        }
        if(effDay <= selectedDay && effDay > recentEffectiveDay) {
          recentEffectiveDay = effDay;
          recent = pd;
        }
      });
      if(!recent) {
        paydays.forEach(pd => {
          let effDay;
          if(pd.type === 'specific'){
            effDay = effectiveDueDate(pd.day, daysInMonth);
          } else if(pd.type === '1st15'){
            effDay = 15;
          } else if(pd.type === 'daily'){
            effDay = selectedDay;
          } else if(pd.type === 'weekly'){
            effDay = selectedDay;
          } else if(pd.type === 'monthly'){
            effDay = daysInMonth;
          }
          if(effDay > recentEffectiveDay) {
            recentEffectiveDay = effDay;
            recent = pd;
          }
        });
      }
      return recent ? recent.paycheckAmount : 0;
    }

    /**************************************************************
     * Calculation and Totals:
     * - The pay period range now displays the full period (from the last payday to the next).
     * - In Required Balances Summary, if tracking is enabled and an account has surplus funds,
     *   the surplus and extra daily discretionary spending (over the remaining days) is displayed.
     **************************************************************/
    document.getElementById('calculateButton').addEventListener('click', function() {
      const cycleDateStr = document.getElementById('cycleDate').value;
      if (!cycleDateStr) {
        alert("Please select a cycle date.");
        return;
      }
      const cycleDate = new Date(cycleDateStr);
      const selectedDay = cycleDate.getDate();
      const currentDaysInMonth = new Date(cycleDate.getFullYear(), cycleDate.getMonth()+1, 0).getDate();

      if (paydays.length === 0) {
        alert("Please add at least one payday.");
        return;
      }

      // Determine the start of the pay period (most recent payday day)
      const periodStart = getMostRecentPaydayDay(selectedDay, currentDaysInMonth);
      // Compute next payday difference from the cycle date
      const nextDiff = computeNextPaydayDiff(selectedDay, currentDaysInMonth);
      let periodEnd = selectedDay + nextDiff;
      // Full period length: from periodStart to periodEnd (wrap if needed)
      let fullPeriodLength = (periodEnd >= periodStart) ? (periodEnd - periodStart + 1) : ((currentDaysInMonth - periodStart + 1) + periodEnd);
      // Remaining days from cycle date to period end
      let remainingDays = (periodEnd >= selectedDay) ? (periodEnd - selectedDay + 1) : ((currentDaysInMonth - selectedDay + 1) + periodEnd);

      const periodEndDisplay = (periodEnd <= currentDaysInMonth) ? periodEnd : (periodEnd - currentDaysInMonth) + " [next cycle]";
      // Display full pay period range (using periodStart, not the cycle date)
      document.getElementById('payPeriodRange').textContent = `(from Day ${periodStart} to Day ${periodEndDisplay} - Total: ${fullPeriodLength} days)`;

      let paycheck = getMostRecentPaycheck(selectedDay, currentDaysInMonth);

      // For custom allocation, ensure allocations sum to paycheck.
      if(balanceTrackingEnabled && document.getElementById('distributionMethod').value === "custom") {
        let totalAllocated = 0;
        bankAccounts.forEach(account => {
          let input = document.getElementById('customAlloc_' + account.id);
          if(input && input.value) {
            totalAllocated += parseFloat(input.value);
          }
        });
        if (Math.abs(totalAllocated - paycheck) > 0.01) {
          alert("Custom allocation amounts do not sum to the paycheck amount of $" + paycheck.toFixed(2) + ". Please adjust your allocations. Remaining: $" + (paycheck - totalAllocated).toFixed(2));
          return;
        }
      }

      // Pre-calculate required expenses per account (for proportional allocation)
      let requiredExpenses = {};
      if(balanceTrackingEnabled) {
        bankAccounts.forEach(account => {
          const billsForAccount = recurringBills.filter(bill => {
            return bill.bankAccountId === account.id && isDueWithin(bill.dueDate, selectedDay, periodEnd, currentDaysInMonth);
          });
          let totalBills = 0;
          billsForAccount.forEach(bill => {
            totalBills += bill.amount;
          });
          let totalPeriodic = 0;
          oneTimeExpenses.forEach(exp => {
            if(exp.bankAccountId === account.id) {
              if(exp.planType === 'occurrence' && exp.occurrences > 0) {
                totalPeriodic += (exp.amount * exp.occurrences) / getExpectedPayPeriodsPerYear();
              } else if(exp.planType === 'specific' && exp.specificMonths.length > 0) {
                if(exp.specificMonths.includes((cycleDate.getMonth()+1).toString()) && isDueWithin(exp.dueDate, selectedDay, periodEnd, currentDaysInMonth)) {
                  totalPeriodic += exp.amount;
                }
              } else {
                if(isDueWithin(exp.dueDate, selectedDay, periodEnd, currentDaysInMonth)) {
                  totalPeriodic += exp.amount;
                }
              }
            }
          });
          requiredExpenses[account.id] = totalBills + totalPeriodic;
        });
      }

      // Build the Required Balances Summary.
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = "";
      let overallCombined = 0;

      bankAccounts.forEach(account => {
        let startingBalance = (account.balance !== null && !isNaN(account.balance)) ? account.balance : (balanceTrackingEnabled ? 0 : 0);
        let allocated = 0;
        if(balanceTrackingEnabled) {
          let method = document.getElementById('distributionMethod').value;
          if(method === "equal") {
            allocated = paycheck / bankAccounts.length;
          } else if(method === "custom") {
            let input = document.getElementById('customAlloc_' + account.id);
            allocated = (input && input.value) ? parseFloat(input.value) : (paycheck / bankAccounts.length);
          } else if(method === "single") {
            let selectedAccountId = document.getElementById('singleAccountSelector').value;
            allocated = (account.id === selectedAccountId) ? paycheck : 0;
          } else if(method === "proportional") {
            let totalReq = Object.values(requiredExpenses).reduce((a, b) => a + b, 0);
            allocated = (totalReq > 0) ? paycheck * (requiredExpenses[account.id] / totalReq) : (paycheck / bankAccounts.length);
          }
        }
        let availableFunds = balanceTrackingEnabled ? (startingBalance + allocated) : ((account.balance !== null && !isNaN(account.balance)) ? account.balance : 0);

        const billsForAccount = recurringBills.filter(bill => {
          return bill.bankAccountId === account.id && isDueWithin(bill.dueDate, selectedDay, periodEnd, currentDaysInMonth);
        });
        let totalBills = 0;
        billsForAccount.forEach(bill => {
          totalBills += bill.amount;
        });
        let totalPeriodic = 0;
        oneTimeExpenses.forEach(exp => {
          if(exp.bankAccountId === account.id) {
            if(exp.planType === 'occurrence' && exp.occurrences > 0) {
              totalPeriodic += (exp.amount * exp.occurrences) / getExpectedPayPeriodsPerYear();
            } else if(exp.planType === 'specific' && exp.specificMonths.length > 0) {
              if(exp.specificMonths.includes((cycleDate.getMonth()+1).toString()) && isDueWithin(exp.dueDate, selectedDay, periodEnd, currentDaysInMonth)) {
                totalPeriodic += exp.amount;
              }
            } else {
              if(isDueWithin(exp.dueDate, selectedDay, periodEnd, currentDaysInMonth)) {
                totalPeriodic += exp.amount;
              }
            }
          }
        });
        const totalRequired = totalBills + totalPeriodic;
        overallCombined += totalRequired;
        const leftover = availableFunds - totalRequired;
        const dailyExtra = leftover > 0 ? (leftover / remainingDays).toFixed(2) : 0;

        const accountDiv = document.createElement('div');
        accountDiv.classList.add('account-summary');
        const header = document.createElement('h3');
        header.textContent = account.name;
        accountDiv.appendChild(header);
        if(balanceTrackingEnabled) {
          const availPara = document.createElement('p');
          availPara.textContent = `Available Funds (Starting Balance + Allocation): $${availableFunds.toFixed(2)}`;
          accountDiv.appendChild(availPara);
          if(leftover > 0) {
            const surplusPara = document.createElement('p');
            surplusPara.style.color = 'green';
            surplusPara.textContent = `Surplus: $${leftover.toFixed(2)} extra funds available.`;
            accountDiv.appendChild(surplusPara);
            const dailyPara = document.createElement('p');
            dailyPara.style.color = 'green';
            dailyPara.textContent = `Extra daily discretionary spending: $${dailyExtra} per day (over ${remainingDays} days remaining).`;
            accountDiv.appendChild(dailyPara);
          }
        }
        const requiredPara = document.createElement('p');
        requiredPara.textContent = `Total Required (from Day ${periodStart} to Day ${periodEndDisplay}): $${totalRequired.toFixed(2)}`;
        accountDiv.appendChild(requiredPara);
        if(balanceTrackingEnabled && availableFunds < totalRequired) {
          const alertPara = document.createElement('p');
          alertPara.style.color = 'red';
          alertPara.textContent = "Insufficient funds! Consider transferring additional funds.";
          accountDiv.appendChild(alertPara);
        }
        const listHeader = document.createElement('p');
        listHeader.textContent = "Upcoming Bills/Expenses:";
        accountDiv.appendChild(listHeader);
        const list = document.createElement('ul');
        billsForAccount.forEach(bill => {
          const li = document.createElement('li');
          li.textContent = `${bill.name} - $${bill.amount.toFixed(2)} due on Day ${effectiveDueDate(bill.dueDate, currentDaysInMonth)}`;
          list.appendChild(li);
        });
        oneTimeExpenses.forEach(exp => {
          if(exp.bankAccountId === account.id && isDueWithin(exp.dueDate, selectedDay, periodEnd, currentDaysInMonth)) {
            let expText = "";
            if(exp.planType === 'occurrence' && exp.occurrences > 0) {
              expText = `${exp.name} - $${exp.amount.toFixed(2)} due on Day ${effectiveDueDate(exp.dueDate, currentDaysInMonth)} (Occurs ${exp.occurrences}x/yr)`;
            } else if(exp.planType === 'specific' && exp.specificMonths.length > 0) {
              expText = `${exp.name} - $${exp.amount.toFixed(2)} due on Day ${effectiveDueDate(exp.dueDate, currentDaysInMonth)} (Due in: ${exp.specificMonths.map(m => monthName(parseInt(m))).join(', ')})`;
            } else {
              expText = `${exp.name} - $${exp.amount.toFixed(2)} due on Day ${effectiveDueDate(exp.dueDate, currentDaysInMonth)} (One-Time)`;
            }
            const li = document.createElement('li');
            li.textContent = expText;
            list.appendChild(li);
          }
        });
        accountDiv.appendChild(list);
        resultsDiv.appendChild(accountDiv);
      });

      // Expense Totals Calculations:
      let payPeriodTotals = {};
      let monthlyTotals = {};
      bankAccounts.forEach(acc => {
        payPeriodTotals[acc.id] = 0;
        monthlyTotals[acc.id] = 0;
      });
      recurringBills.forEach(bill => {
        if(isDueWithin(bill.dueDate, selectedDay, periodEnd, currentDaysInMonth)) {
          payPeriodTotals[bill.bankAccountId] += bill.amount;
        }
        monthlyTotals[bill.bankAccountId] += bill.amount;
      });
      oneTimeExpenses.forEach(exp => {
        if(exp.planType === 'occurrence' && exp.occurrences > 0) {
          payPeriodTotals[exp.bankAccountId] += (exp.amount * exp.occurrences) / getExpectedPayPeriodsPerYear();
          monthlyTotals[exp.bankAccountId] += (exp.amount * exp.occurrences) / 12;
        } else if(exp.planType === 'specific' && exp.specificMonths.length > 0) {
          if(exp.specificMonths.includes((cycleDate.getMonth()+1).toString()) && isDueWithin(exp.dueDate, selectedDay, periodEnd, currentDaysInMonth)) {
            payPeriodTotals[exp.bankAccountId] += exp.amount;
          }
          if(exp.specificMonths.includes((cycleDate.getMonth()+1).toString())) {
            monthlyTotals[exp.bankAccountId] += exp.amount;
          }
        }
      });
      let combinedPayPeriod = 0;
      let combinedMonthly = 0;
      for (let id in payPeriodTotals) {
        combinedPayPeriod += payPeriodTotals[id];
      }
      for (let id in monthlyTotals) {
        combinedMonthly += monthlyTotals[id];
      }
      document.getElementById('payPeriodCombined').innerHTML = `<strong>Total Expenses for This Pay Period:</strong> $${combinedPayPeriod.toFixed(2)}`;
      let payPeriodBankList = "<ul class='totals-list'>";
      bankAccounts.forEach(acc => {
        payPeriodBankList += `<li>${acc.name}: $${payPeriodTotals[acc.id].toFixed(2)}</li>`;
      });
      payPeriodBankList += "</ul>";
      document.getElementById('payPeriodByBank').innerHTML = payPeriodBankList;

      document.getElementById('monthlyCombined').innerHTML = `<strong>Combined Monthly Total:</strong> $${combinedMonthly.toFixed(2)}`;
      let monthlyBankList = "";
      bankAccounts.forEach(acc => {
        monthlyBankList += `<h4>${acc.name} - Total: $${monthlyTotals[acc.id].toFixed(2)}</h4>`;
        let billsList = "<ul>";
        recurringBills.filter(bill => bill.bankAccountId === acc.id).forEach(bill => {
          billsList += `<li>${bill.name} - $${bill.amount.toFixed(2)} due on Day ${bill.dueDate}</li>`;
        });
        oneTimeExpenses.filter(exp => exp.bankAccountId === acc.id).forEach(exp => {
          if(exp.planType === 'occurrence' && exp.occurrences > 0) {
            billsList += `<li>${exp.name} - $${exp.amount.toFixed(2)} (Occurs ${exp.occurrences}x/yr)</li>`;
          } else if(exp.planType === 'specific' && exp.specificMonths.includes((cycleDate.getMonth()+1).toString())) {
            billsList += `<li>${exp.name} - $${exp.amount.toFixed(2)} (Due in: ${exp.specificMonths.map(m => monthName(parseInt(m))).join(', ')})</li>`;
          }
        });
        billsList += "</ul>";
        monthlyBankList += billsList;
      });
      document.getElementById('monthlyByBank').innerHTML = monthlyBankList;
    });

    /**************************************************************
     * CSV Import for Recurring Bills.
     **************************************************************/
    document.getElementById('recurringCSV').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.csv')) {
        alert("Please upload a file in .csv format.");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const csvData = evt.target.result;
          const lines = csvData.split(/\r\n|\n/).filter(line => line.trim() !== '');
          if (lines.length < 2) {
            alert("CSV file does not contain any data rows.");
            return;
          }
          const headers = lines[0].split(',').map(h => h.trim());
          const requiredHeaders = ["Bill Name", "Bill Amount", "Due Date", "Bank Account"];
          for (let header of requiredHeaders) {
            if (!headers.includes(header)) {
              alert("Recurring Bills CSV is missing required column: " + header);
              return;
            }
          }
          const data = [];
          const errors = [];
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (line.trim() === "") continue;
            const fields = line.split(',');
            const rowObj = {};
            headers.forEach((header, index) => {
              rowObj[header] = fields[index] ? fields[index].trim() : "";
            });
            if (!rowObj["Bill Name"] || !rowObj["Bill Amount"] || !rowObj["Due Date"] || !rowObj["Bank Account"]) {
              errors.push(`Row ${i+1}: Missing required data.`);
              continue;
            }
            const amount = parseFloat(rowObj["Bill Amount"]);
            if (isNaN(amount) || amount <= 0) {
              errors.push(`Row ${i+1}: Bill Amount must be a positive number.`);
              continue;
            }
            const dueDate = parseInt(rowObj["Due Date"]);
            if (isNaN(dueDate) || dueDate < 1 || dueDate > 31) {
              errors.push(`Row ${i+1}: Due Date must be between 1 and 31.`);
              continue;
            }
            let bankAcc = bankAccounts.find(acc => acc.name.toLowerCase() === rowObj["Bank Account"].toLowerCase());
            if (!bankAcc) {
              const bankId = Date.now().toString() + "_bank_csv_" + i;
              const newBank = { id: bankId, name: rowObj["Bank Account"], balance: null };
              bankAccounts.push(newBank);
              updateBankAccountList();
              updateBankAccountDropdowns();
              updateDistributionSection();
              bankAcc = newBank;
            }
            data.push({
              id: Date.now().toString() + "_bill" + i,
              name: rowObj["Bill Name"],
              amount: amount,
              dueDate: dueDate,
              bankAccountId: bankAcc.id
            });
          }
          if (errors.length > 0) {
            alert("Errors found while parsing CSV:\n" + errors.join("\n"));
            return;
          }
          data.forEach(bill => recurringBills.push(bill));
          updateBillList();
          alert("Recurring bills imported successfully.");
        } catch (err) {
          console.error(err);
          alert("An error occurred while processing the CSV file: " + err.message);
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
